using Bee.Base;
using Bee.Define;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace Bee.Db
{
    /// <summary>
    /// SQL Server 資料庫建立 Select 命令產生的類別。
    /// </summary>
    public class SqlSelectCommandBuilder
    {
        private readonly FormDefine _formDefine;

        /// <summary>
        /// 建構函式。
        /// </summary>
        /// <param name="formDefine">表單定義。</param>
        public SqlSelectCommandBuilder(FormDefine formDefine)
        {
            _formDefine = formDefine;
        }

        /// <summary>
        /// 建立 Select 語法的 DbCommandSpec。
        /// </summary>
        /// <param name="tableName">資料表名稱。</param>
        /// <param name="selectFields">要取得的欄位集合字串，以逗點分隔欄位名稱，空字串表示取得所有欄位。</param>
        /// <param name="filter">過濾條件 FilterNode，若為 null 則不加 WHERE。</param>
        public DbCommandSpec Build(string tableName, string selectFields, FilterNode filter = null)
        {
            if (string.IsNullOrWhiteSpace(tableName))
                throw new ArgumentException("tableName cannot be null or whitespace.", nameof(tableName));

            var formTable = _formDefine.Tables[tableName];
            if (formTable == null)
                throw new InvalidOperationException($"Cannot find the specified table: {tableName}");

            var dbTableName = !string.IsNullOrWhiteSpace(formTable.DbTableName) ? formTable.DbTableName : formTable.TableName;
            var selectContext = GetSelectContext(formTable);
            var selectFieldNames = GetSelectFields(formTable, selectFields);
            var joins = new TableJoinCollection();

            var sb = new StringBuilder();
            var selectParts = new List<string>();
            foreach (var fieldName in selectFieldNames)
            {
                var field = formTable.Fields.GetOrDefault(fieldName);
                if (field == null)
                    throw new InvalidOperationException($"Field '{fieldName}' does not exist in table '{formTable.TableName}'.");
                if (field.Type == FieldType.DbField)
                {
                    selectParts.Add($"    A.{QuoteIdentifier(fieldName)}");
                }
                else
                {
                    var mapping = selectContext.FieldMappings.GetOrDefault(fieldName);
                    if (mapping == null)
                        throw new InvalidOperationException($"Field mapping for '{fieldName}' is null.");
                    selectParts.Add($"    {mapping.SourceAlias}.{QuoteIdentifier(mapping.SourceField)} AS {QuoteIdentifier(fieldName)}");

                    // 將使用的資料表 Join 關係加入集合
                    AddTableJoin(selectContext, joins, mapping.TableJoin);
                }
            }

            sb.AppendLine("SELECT");
            sb.AppendLine(string.Join(",\n", selectParts));
            sb.AppendLine($"FROM {QuoteIdentifier(dbTableName)} A");

            var joinList = joins.OrderBy(j => j.RightAlias);
            foreach (var join in joinList)
            {
                var joinKeyword = join.JoinType.ToString().ToUpperInvariant() + " JOIN";
                sb.AppendLine($"{joinKeyword} {QuoteIdentifier(join.RightTable)} {join.RightAlias} ON {join.LeftAlias}.{QuoteIdentifier(join.LeftField)} = {join.RightAlias}.{QuoteIdentifier(join.RightField)}");
            }

            IReadOnlyDictionary<string, object> parameters = null;
            if (filter != null)
            {
                var remappedFilter = RemapFilterNodeFields(filter, selectContext);
                var whereBuilder = new SqlServerWhereBuilder();
                var whereResult = whereBuilder.Build(remappedFilter, true);
                if (!string.IsNullOrWhiteSpace(whereResult.WhereClause))
                {
                    sb.AppendLine(whereResult.WhereClause);
                    parameters = whereResult.Parameters;
                }
            }

            string sql = sb.ToString();
            if (parameters != null && parameters.Count > 0)
                return new DbCommandSpec(DbCommandKind.DataTable, sql, parameters);
            else
                return new DbCommandSpec(DbCommandKind.DataTable, sql);
        }

        /// <summary>
        /// 將使用的資料表 Join 關係加入集合。
        /// </summary>
        /// <param name="context">描述 Select 查詢時所需的欄位來源與 Join 關係集合。</param>
        /// <param name="joins">資料表 Join 關係集合。</param>
        /// <param name="join">要加入資料表 Join 關係。</param>
        /// <param name="visited">已遞迴過的 Join Key 集合，用於防止環狀參照造成無窮遞迴。呼叫端可不傳，預設自動建立。</param>
        private void AddTableJoin(SelectContext context, TableJoinCollection joins, TableJoin join, HashSet<string> visited = null)
        {
            if (visited == null)
                visited = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

            if (visited.Contains(join.Key)) { return; }
            visited.Add(join.Key);

            if (joins.Contains(join.Key)) { return; }

            joins.Add(join);
            if (join.LeftAlias == "A") { return; }

            // 如果 LeftAlias 不為 A，表示左側非主表，要加入中間的 JOIN 關係
            var srcJoin = context.Joins.FindRightAlias(join.LeftAlias);
            if (srcJoin != null)
                AddTableJoin(context, joins, srcJoin, visited);
        }

        /// <summary>
        /// 依據資料庫類型，回傳適當的識別字串跳脫格式。
        /// </summary>
        /// <param name="identifier">識別字名稱。</param>
        /// <returns>跳脫後的識別字。</returns>
        private string QuoteIdentifier(string identifier)
        {
            return DbFunc.QuoteIdentifier(DatabaseType.SQLServer, identifier);
        }

        /// <summary>
        /// 取得 Select 的欄位集合。
        /// </summary>
        /// <param name="formTable">表單資料表。</param>
        /// <param name="selectFields">要取得的欄位集合字串，以逗點分隔欄位名稱，空字串表示取得所有欄位</param>
        private StringHashSet GetSelectFields(FormTable formTable, string selectFields)
        {
            var set = new StringHashSet();
            if (string.IsNullOrWhiteSpace(selectFields))
            {
                // 取得所有欄位
                foreach (var field in formTable.Fields)
                {
                    set.Add(field.FieldName);
                }
            }
            else
            {
                // 只取指定欄位
                set.Add(selectFields, ",");
            }
            return set;
        }

        /// <summary>
        /// 取得 Select 查詢時所需的欄位來源與 Join 關係集合。
        /// </summary>
        /// <param name="formTable">表單資料表。</param>
        private SelectContext GetSelectContext(FormTable formTable)
        {
            var builder = new SelectContextBuilder(formTable);
            return builder.Build();
        }

        /// <summary>
        /// 重新映射過濾節點中的欄位名稱為 SQL 查詢所需的格式（加上資料表別名）。
        /// </summary>
        /// <param name="node">要重新映射的過濾節點。</param>
        /// <param name="selectContext">查詢欄位來源與 Join 關係集合。</param>
        /// <returns>重新映射後的過濾節點。</returns>
        private FilterNode RemapFilterNodeFields(FilterNode node, SelectContext selectContext)
        {
            if (node.Kind == FilterNodeKind.Condition)
            {
                var cond = (FilterCondition)node;
                var mapping = selectContext.FieldMappings.GetOrDefault(cond.FieldName);
                string fieldExpr;
                if (mapping != null)
                {
                    fieldExpr = $"{mapping.SourceAlias}.{QuoteIdentifier(mapping.SourceField)}";
                }
                else
                {
                    // 本表欄位，預設別名 A
                    fieldExpr = $"A.{QuoteIdentifier(cond.FieldName)}";
                }
                return new FilterCondition(fieldExpr, cond.Operator, cond.Value);
            }
            else if (node.Kind == FilterNodeKind.Group)
            {
                var group = (FilterGroup)node;
                var newGroup = new FilterGroup(group.Operator);
                foreach (var child in group.Nodes)
                    newGroup.Nodes.Add(RemapFilterNodeFields(child, selectContext));
                return newGroup;
            }
            else
            {
                return node;
            }
        }


    }
}